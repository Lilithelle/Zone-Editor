<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      .basecolor {
        background-color: #000000;
        color: #B0B0B0;
      }
      a, button {
        font-size:12pt;
        border: 1px solid #000000;
        margin: 1px 0px 1px;
        outline: none;
      }
      div {
        font-family:'Courier New';
        font-size:12pt;
      }
      select {
        display:none;
        font-size:12pt;
      }
    </style>
    <title id="fileTitle">Untitled</title>
  </head>
  <body>
    <div>
      <div>
        <span onclick="debug()">Line:</span><span id="lineNo">1&nbsp;&nbsp;&nbsp;&nbsp;</span>
        <input type="file" id="file-input" accept=".mob, .obj, .pow, .qst, .shp, .soc, .wld, .zon" />
        <a id="file-output" href="data:text/plain;charset=utf-8," download="Untitled" onclick="writeFile()">Save File</a>
        <button type="button" onclick="validateFile()">Check file for errors.</button>
      </div>
      <div style="font-size:0pt;">
        <button type="button" id="color-1" style="border: 1px solid #808080;" class="basecolor">&nbsp;&amp;n&nbsp;&nbsp;</button>
        <select id="palette-1"><option>&amp;n</option></select>
        <button type="button" id="color0">&nbsp;&amp;+l&nbsp;</button>
        <select id="palette0"><option>&amp;f000</option><option>&amp;f232</option><option>&amp;f232</option><option>&amp;f233</option><option>&amp;f234</option><option>&amp;f235</option><option>&amp;f236</option><option>&amp;f237</option></select>
        <button type="button" id="color1">&nbsp;&amp;+r&nbsp;</button>
        <select id="palette1"><option>&amp;f001</option><option>&amp;f052</option><option>&amp;f088</option><option>&amp;f124</option><option>&amp;f160</option><option>&amp;f161</option><option>&amp;f166</option><option>&amp;f095</option></select>
        <button type="button" id="color2">&nbsp;&amp;+g&nbsp;</button>
        <select id="palette2"><option>&amp;f002</option><option>&amp;f022</option><option>&amp;f028</option><option>&amp;f034</option><option>&amp;f040</option><option>&amp;f041</option><option>&amp;f076</option><option>&amp;f065</option></select>
        <button type="button" id="color3">&nbsp;&amp;+y&nbsp;</button>
        <select id="palette3"><option>&amp;f003</option><option>&amp;f058</option><option>&amp;f064</option><option>&amp;f094</option><option>&amp;f100</option><option>&amp;f070</option><option>&amp;f106</option><option>&amp;f130</option><option>&amp;f136</option><option>&amp;f142</option><option>&amp;f112</option><option>&amp;f148</option><option>&amp;f172</option><option>&amp;f178</option><option>&amp;f184</option><option>&amp;f101</option></select>
        <button type="button" id="color4">&nbsp;&amp;+b&nbsp;</button>
        <select id="palette4"><option>&amp;f004</option><option>&amp;f017</option><option>&amp;f018</option><option>&amp;f019</option><option>&amp;f020</option><option>&amp;f026</option><option>&amp;f056</option><option>&amp;f060</option></select>
        <button type="button" id="color5">&nbsp;&amp;+m&nbsp;</button>
        <select id="palette5"><option>&amp;f005</option><option>&amp;f053</option><option>&amp;f054</option><option>&amp;f089</option><option>&amp;f090</option><option>&amp;f055</option><option>&amp;f091</option><option>&amp;f125</option><option>&amp;f126</option><option>&amp;f127</option><option>&amp;f092</option><option>&amp;f128</option><option>&amp;f162</option><option>&amp;f163</option><option>&amp;f164</option><option>&amp;f096</option></select>
        <button type="button" id="color6">&nbsp;&amp;+c&nbsp;</button>
        <select id="palette6"><option>&amp;f006</option><option>&amp;f023</option><option>&amp;f024</option><option>&amp;f029</option><option>&amp;f030</option><option>&amp;f025</option><option>&amp;f031</option><option>&amp;f035</option><option>&amp;f036</option><option>&amp;f037</option><option>&amp;f032</option><option>&amp;f038</option><option>&amp;f042</option><option>&amp;f043</option><option>&amp;f044</option><option>&amp;f066</option></select>
        <button type="button" id="color7">&nbsp;&amp;+w&nbsp;</button>
        <select id="palette7"><option>&amp;f007</option><option>&amp;f102</option><option>&amp;f245</option><option>&amp;f246</option><option>&amp;f247</option><option>&amp;f248</option><option>&amp;f145</option><option>&amp;f249</option><option>&amp;f250</option></select>
        <button type="button" id="color8">&nbsp;&amp;+L&nbsp;</button>
        <select id="palette8"><option>&amp;f008</option><option>&amp;f238</option><option>&amp;f239</option><option>&amp;f240</option><option>&amp;f059</option><option>&amp;f241</option><option>&amp;f242</option><option>&amp;f243</option></select>
        <button type="button" id="color9">&nbsp;&amp;+R&nbsp;</button>
        <select id="palette9"><option>&amp;f009</option><option>&amp;f196</option><option>&amp;f197</option><option>&amp;f202</option><option>&amp;f131</option><option>&amp;f132</option><option>&amp;f138</option><option>&amp;f167</option><option>&amp;f168</option><option>&amp;f173</option><option>&amp;f174</option><option>&amp;f175</option><option>&amp;f203</option><option>&amp;f204</option><option>&amp;f205</option><option>&amp;f209</option><option>&amp;f181</option><option>&amp;f210</option><option>&amp;f211</option><option>&amp;f216</option><option>&amp;f217</option><option>&amp;f218</option><option>&amp;f224</option></select>
        <button type="button" id="color10">&nbsp;&amp;+G&nbsp;</button>
        <select id="palette10"><option>&amp;f010</option><option>&amp;f046</option><option>&amp;f047</option><option>&amp;f082</option><option>&amp;f071</option><option>&amp;f107</option><option>&amp;f077</option><option>&amp;f078</option><option>&amp;f108</option><option>&amp;f113</option><option>&amp;f083</option><option>&amp;f084</option><option>&amp;f114</option><option>&amp;f119</option><option>&amp;f150</option><option>&amp;f155</option><option>&amp;f120</option><option>&amp;f121</option><option>&amp;f151</option><option>&amp;f156</option><option>&amp;f157</option><option>&amp;f193</option><option>&amp;f194</option></select>
        <button type="button" id="color11">&nbsp;&amp;+Y&nbsp;</button>
        <select id="palette11"><option>&amp;f011</option><option>&amp;f118</option><option>&amp;f154</option><option>&amp;f190</option><option>&amp;f208</option><option>&amp;f214</option><option>&amp;f220</option><option>&amp;f226</option><option>&amp;f137</option><option>&amp;f143</option><option>&amp;f144</option><option>&amp;f149</option><option>&amp;f179</option><option>&amp;f185</option><option>&amp;f180</option><option>&amp;f186</option><option>&amp;f191</option><option>&amp;f215</option><option>&amp;f221</option><option>&amp;f227</option><option>&amp;f187</option><option>&amp;f192</option><option>&amp;f222</option><option>&amp;f228</option><option>&amp;f223</option><option>&amp;f229</option><option>&amp;f230</option></select>
        <button type="button" id="color12">&nbsp;&amp;+B&nbsp;</button>
        <select id="palette12"><option>&amp;f012</option><option>&amp;f021</option><option>&amp;f027</option><option>&amp;f057</option><option>&amp;f061</option><option>&amp;f067</option><option>&amp;f062</option><option>&amp;f068</option><option>&amp;f098</option><option>&amp;f103</option><option>&amp;f063</option><option>&amp;f069</option><option>&amp;f075</option><option>&amp;f099</option><option>&amp;f104</option><option>&amp;f110</option><option>&amp;f105</option><option>&amp;f111</option><option>&amp;f141</option><option>&amp;f146</option><option>&amp;f147</option><option>&amp;f153</option><option>&amp;f189</option></select>
        <button type="button" id="color13">&nbsp;&amp;+M&nbsp;</button>
        <select id="palette13"><option>&amp;f013</option><option>&amp;f093</option><option>&amp;f129</option><option>&amp;f165</option><option>&amp;f198</option><option>&amp;f199</option><option>&amp;f200</option><option>&amp;f201</option><option>&amp;f097</option><option>&amp;f133</option><option>&amp;f134</option><option>&amp;f139</option><option>&amp;f169</option><option>&amp;f170</option><option>&amp;f135</option><option>&amp;f140</option><option>&amp;f171</option><option>&amp;f176</option><option>&amp;f206</option><option>&amp;f207</option><option>&amp;f177</option><option>&amp;f182</option><option>&amp;f212</option><option>&amp;f213</option><option>&amp;f183</option><option>&amp;f219</option><option>&amp;f225</option></select>
        <button type="button" id="color14">&nbsp;&amp;+C&nbsp;</button>
        <select id="palette14"><option>&amp;f014</option><option>&amp;f033</option><option>&amp;f039</option><option>&amp;f045</option><option>&amp;f048</option><option>&amp;f049</option><option>&amp;f050</option><option>&amp;f051</option><option>&amp;f072</option><option>&amp;f073</option><option>&amp;f074</option><option>&amp;f079</option><option>&amp;f080</option><option>&amp;f109</option><option>&amp;f081</option><option>&amp;f085</option><option>&amp;f086</option><option>&amp;f087</option><option>&amp;f115</option><option>&amp;f116</option><option>&amp;f117</option><option>&amp;f122</option><option>&amp;f123</option><option>&amp;f152</option><option>&amp;f158</option><option>&amp;f159</option><option>&amp;f195</option></select>
        <button type="button" id="color15">&nbsp;&amp;+W&nbsp;</button>
        <select id="palette15"><option>&amp;f015</option><option>&amp;f251</option><option>&amp;f252</option><option>&amp;f188</option><option>&amp;f253</option><option>&amp;f254</option><option>&amp;f255</option></select>
      </div>
      <div id="file-in" contenteditable="true" class="basecolor" style="height:90vh;width:100%;overflow-y:auto;" onclick="showLineNo()" onkeyup="showLineNo()"></div>
    </div>
    <footer>
      <small>&copy; Copyright 2018, Birdsnest Management Limited.</small>
    </footer>
    <script>
    function debug() {
      console.log(fileIn.innerHTML);
      for(index = 0; index < fileIn.childNodes.length; index++) {
        console.log("nodeName: '" + fileIn.childNodes[index].nodeName  + "', NodeValue: '" + fileIn.childNodes[index].nodeValue + "', nodeType: " + fileIn.childNodes[index].nodeType);
      }
    }
    // must not be one of the 256, should match basecolor style class
    var defaultColor = "#B0B0B0";
    var colors = ["#000000", "#800000", "#008000", "#808000", "#000080",
      "#800080", "#008080", "#c0c0c0", "#808080", "#ff0000", "#00ff00",
      "#ffff00", "#0000ff", "#ff00ff", "#00ffff", "#ffffff", "#000000",
      "#00005f", "#000087", "#0000af", "#0000d7", "#0000ff", "#005f00",
      "#005f5f", "#005f87", "#005faf", "#005fd7", "#005fff", "#008700",
      "#00875f", "#008787", "#0087af", "#0087d7", "#0087ff", "#00af00",
      "#00af5f", "#00af87", "#00afaf", "#00afd7", "#00afff", "#00d700",
      "#00d75f", "#00d787", "#00d7af", "#00d7d7", "#00d7ff", "#00ff00",
      "#00ff5f", "#00ff87", "#00ffaf", "#00ffd7", "#00ffff", "#5f0000",
      "#5f005f", "#5f0087", "#5f00af", "#5f00d7", "#5f00ff", "#5f5f00",
      "#5f5f5f", "#5f5f87", "#5f5faf", "#5f5fd7", "#5f5fff", "#5f8700",
      "#5f875f", "#5f8787", "#5f87af", "#5f87d7", "#5f87ff", "#5faf00",
      "#5faf5f", "#5faf87", "#5fafaf", "#5fafd7", "#5fafff", "#5fd700",
      "#5fd75f", "#5fd787", "#5fd7af", "#5fd7d7", "#5fd7ff", "#5fff00",
      "#5fff5f", "#5fff87", "#5fffaf", "#5fffd7", "#5fffff", "#870000",
      "#87005f", "#870087", "#8700af", "#8700d7", "#8700ff", "#875f00",
      "#875f5f", "#875f87", "#875faf", "#875fd7", "#875fff", "#878700",
      "#87875f", "#878787", "#8787af", "#8787d7", "#8787ff", "#87af00",
      "#87af5f", "#87af87", "#87afaf", "#87afd7", "#87afff", "#87d700",
      "#87d75f", "#87d787", "#87d7af", "#87d7d7", "#87d7ff", "#87ff00",
      "#87ff5f", "#87ff87", "#87ffaf", "#87ffd7", "#87ffff", "#af0000",
      "#af005f", "#af0087", "#af00af", "#af00d7", "#af00ff", "#af5f00",
      "#af5f5f", "#af5f87", "#af5faf", "#af5fd7", "#af5fff", "#af8700",
      "#af875f", "#af8787", "#af87af", "#af87d7", "#af87ff", "#afaf00",
      "#afaf5f", "#afaf87", "#afafaf", "#afafd7", "#afafff", "#afd700",
      "#afd75f", "#afd787", "#afd7af", "#afd7d7", "#afd7ff", "#afff00",
      "#afff5f", "#afff87", "#afffaf", "#afffd7", "#afffff", "#d70000",
      "#d7005f", "#d70087", "#d700af", "#d700d7", "#d700ff", "#d75f00",
      "#d75f5f", "#d75f87", "#d75faf", "#d75fd7", "#d75fff", "#d78700",
      "#d7875f", "#d78787", "#d787af", "#d787d7", "#d787ff", "#d7af00",
      "#d7af5f", "#d7af87", "#d7afaf", "#d7afd7", "#d7afff", "#d7d700",
      "#d7d75f", "#d7d787", "#d7d7af", "#d7d7d7", "#d7d7ff", "#d7ff00",
      "#d7ff5f", "#d7ff87", "#d7ffaf", "#d7ffd7", "#d7ffff", "#ff0000",
      "#ff005f", "#ff0087", "#ff00af", "#ff00d7", "#ff00ff", "#ff5f00",
      "#ff5f5f", "#ff5f87", "#ff5faf", "#ff5fd7", "#ff5fff", "#ff8700",
      "#ff875f", "#ff8787", "#ff87af", "#ff87d7", "#ff87ff", "#ffaf00",
      "#ffaf5f", "#ffaf87", "#ffafaf", "#ffafd7", "#ffafff", "#ffd700",
      "#ffd75f", "#ffd787", "#ffd7af", "#ffd7d7", "#ffd7ff", "#ffff00",
      "#ffff5f", "#ffff87", "#ffffaf", "#ffffd7", "#ffffff", "#080808",
      "#121212", "#1c1c1c", "#262626", "#303030", "#3a3a3a", "#444444",
      "#4e4e4e", "#585858", "#626262", "#6c6c6c", "#767676", "#808080",
      "#8a8a8a", "#949494", "#9e9e9e", "#a8a8a8", "#b2b2b2", "#bcbcbc",
      "#c6c6c6", "#d0d0d0", "#dadada", "#e4e4e4", "#eeeeee", defaultColor];
    var fileLines = [], fileName = "Untitled";
    var cursorNode, lastAnsiF, lastAnsiB, fileType, verifyWindow;
    var fileIn = document.getElementById('file-in');
    var chooseFile = document.getElementById('file-input');
    var saveFile = document.getElementById('file-output');
    var fileDebug = document.getElementById('file-debug');
    var mobVerify = [], objVerify = [], qstVerify = [], shpVerify = [], socVerify = [], wldVerify = [], zonVerify = [];
    mobVerify.push(new Parser(/^#\d{1,6}$/, "#mob-number(6 digit)", 1, 0));
    mobVerify.push(new Parser(/^[0-9A-Z'\-\s]+~$/i, "keywords-list~", 1, 0));
    mobVerify.push(new Parser(/^[^~]+~$/, "mob-name~", 1, 0));
    mobVerify.push(new Parser(/^[^~]+~$/, "mob-in-room-string~", 1, 0));
    mobVerify.push(new Parser(/^[^~]*$/, "mob-description", 0, 1));
    mobVerify.push(new Parser(/^~$/, "~", 1, 0));
    mobVerify.push(new Parser(/^\d{1,10}\s\d{1,10}\s\d{1,10}\s\-?(\d{1,3}|1000)\sS$/, "flags(10 digit) affect1(10 digit) affect2(10 digit) alignment(-1000 to 1000) 'S'", 1, 0));
    mobVerify.push(new Parser(/[0-9A-Z]{1,2}\s\d{1,5}\s\d{1,5}(\s|\s[0-9A-Z]{1,2}(\.[0-9A-Z]{1,2})*)?$/i, "race-type(2 letter) height(5 digit) weight(5 digit) and optional hate list(2 letter combos joined by dots)", 1, 0));
    mobVerify.push(new Parser(/^[0-5]?\d\s\d{1,3}\s\-?\d{1,3}\s\d{1,6}d\d{1,6}\+\d{1,6}\s\d{1,3}d\d{1,3}\+\d{1,3}$/, "level(0-59) thaco(3 digit) ac(3 digit) hp-dice(eg. 5d5+50) damage-dice(eg. 3d4+10)", 1, 0));
    mobVerify.push(new Parser(/^\d{1,5}\.\d{1,5}\.\d{1,5}\.\d{1,5}\s\d{1,9}$/, "coins(5 digit.5 digit.5 digit.5 digit) experience(9 digit)", 1, 0));
    mobVerify.push(new Parser(/^(\d{1,2}|1[0-2]\d|13[0-1])\s(\d{1,2}|1[0-2]\d|13[0-1])\s[0-2](\s?\s?\s?|\s(\d|1\d|2[0-5])\s?\s?|\s(\d|1\d|2[0-5])\s(\d|\d\d|100)\s?|\s(\d|1\d|2[0-5])\s(\d|\d\d|100)\s\d{1,5})$/, "load-position(0-131) default-position(0-131) sex(0-2) and optionally class(0-25), magic-resist(0-100), and prestige(5 digits)", 1, 0));
    mobVerify.push(new Parser(/^POWER:\s[0-9A-Za-z'\- ]+(\s*,\s*[0-9A-Za-z'\- ]+)*$/, "POWER: powers-list", 1, 1));
    mobVerify.push(new Parser(/^TEMPLATE:\s[0-9A-Za-z'\-\+]+(\s*,\s*[0-9A-Za-z'\-\+]+)*$/, "TEMPLATE: template-list", 1, 1));
    mobVerify.push(new Parser(/^FLAGS:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "FLAGS: flags-list", 1, 1));
    mobVerify.push(new Parser(/^EQUIP(MENT)?:\s\d{1,6}(\s*,\s*\d{1,6})*$/, "EQUIP(MENT): number-list(6 digit)", 1 , 1));
    mobVerify.push(new Parser(/^AFFECTS:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "AFFECTS: affects-list", 1 , 1));
    objVerify.push(new Parser(/^#\d{1,6}$/, "#object-number(6 digit)", 1, 0));
    objVerify.push(new Parser(/^[0-9A-Z'\-\s]+~$/i, "keywords-list~", 1, 0));
    objVerify.push(new Parser(/^[^~]+~$/, "object-name~", 1, 0));
    objVerify.push(new Parser(/^[^~]+~$/, "object-in-room-string~", 1, 0));
    objVerify.push(new Parser(/^~$/, "~", 1, 0));
    objVerify.push(new Parser(/^([1-9]|[1-3]\d|4[0-8])\s\d{1,10}\s\d{1,8}(\s\d{1,10})?(\s\d{1,5})?$/, "type(1-48) extra-flags(10 digit) wear-flags(10 digit) optional anti-flags(10 digit) optional anti-align(5 digit)", 1, 0));
    objVerify.push(new Parser(/^\-?\d{1,10}\s\-?\d{1,10}(\s\-?\d{1,10}\s\-?\d{1,10}){1,3}$/, "4, 6, or 8 values(+/- 10 digit)", 1, 0));
    objVerify.push(new Parser(/^\-?\d{1,4}\s\d{1,7}\s0$/, "weight(+/- 4 digit) value(7 digit) storage-cost(0)", 1, 0));
    objVerify.push(new Parser(/^\d{1,10}$/, "special-1", 1, 3));
    objVerify.push(new Parser(/^\d{1,10}$/, "special-2", 1, 2));
    objVerify.push(new Parser(/^\d{1,10}$/, "special-3", 1, 1));
    objVerify.push(new Parser(/^E$/, "E", 1, 4));
    objVerify.push(new Parser(/^.+~$/, "description keywords follow by a '~'", 1, 0));
    objVerify.push(new Parser(/^[^~]+$/, "object-description", 0, 1));
    objVerify.push(new Parser(/^~$/, "~", -3, 0));
    objVerify.push(new Parser(/^T$/, "T", 1, 2));
    objVerify.push(new Parser(/^\d{1,4}\s\d{1,2}\s\-?\d{1,5}\s\d{1,3}\s\d{1,4}\s\d{1,4}$/, "trigger-type(4 digit) damage-type(2 digit) charges(+/- 5 digits) level(3 digits) no-of-dice(4 digit) size-of-dice(4 digit)", 1, 0));
    objVerify.push(new Parser(/^A\s\d{1,2}\s\-?\d{1,3}$/, "A location(2 digit) modifier(+/- 3 digit)", 3, 1));
    objVerify.push(new Parser(/^A$/, "A", 1, 5));
    objVerify.push(new Parser(/^\d{1,2}\s\-?\d{1,3}$/, "location(2 digit) modifier(+/- 3 digit)", 1, 0));
    objVerify.push(new Parser(/^A\s\d{1,2}\s\-?\d{1,3}$/, "A location(2 digit) modifier(+/- 3 digit)", 3, 1));
    objVerify.push(new Parser(/^A$/, "A", 1, 2));
    objVerify.push(new Parser(/^\d{1,2}\s\-?\d{1,3}$/, "location(2 digit) modifier(+/- 3 digit)", 1, 0));
    objVerify.push(new Parser(/^M\s\d{1,2}(\s\d{1,4}\s\d{1,4}\s\-?\d{1,2}\s\d{1,2})?$/, "M enchantment(2 digit) optional:damage(4 digit) frequency(4 digit) modifier(+/- 2 digit) duration(2 digit)", 0, 1));
    objVerify.push(new Parser(/^RESIST:\s[A-Za-z]+\s\-?\d{1,3}(\s*,\s*[A-Za-z]+\s\-?\d{1,3})*$/, "RESIST: resist-list", 1, 1));
    objVerify.push(new Parser(/^POWER:\s[0-9A-Za-z'\- ]+(\s*,\s*[0-9A-Za-z'\- ]+)*$/, "POWER: powers-name-list", 1, 1));
    objVerify.push(new Parser(/^AFFECTS:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "AFFECTS: affects-list", 1, 1));
    objVerify.push(new Parser(/^FLAGS:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "FLAGS: flags-list", 1, 1));
    objVerify.push(new Parser(/^WEAR:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "WEAR: wear-list", 1, 1));
    objVerify.push(new Parser(/^ANTI:\s[\w\s]+(\s*,\s*[\w\s]+)*$/, "ANTI: anti-list", 1, 1));
    objVerify.push(new Parser(/^TYPE:\s\w$/, "TYPE: object-type", 1, 1));
    qstVerify.push(new Parser(/^#\d{1,6}$/, "#mob-number(6 digit)", 1, 0));
    qstVerify.push(new Parser(/^M$/, "M", 1, 4));
    qstVerify.push(new Parser(/^[0-9A-Z'\-\s]+~$/i, "keywords-list~", 1, 0));
    qstVerify.push(new Parser(/^[^~]*$/, "quest-message", 0, 1));
    qstVerify.push(new Parser(/^~$/, "~", -3, 0));
    qstVerify.push(new Parser(/^Q$/, "Q", 1, 10));
    qstVerify.push(new Parser(/^[^~]*$/, "completion-message", 0, 1));
    qstVerify.push(new Parser(/^~$/, "~", 1, 0));
    qstVerify.push(new Parser(/^G\s(C\s\d{1,8}|I\s\d{1,6})$/, "G C coins(8 digits) or G I object(6 digits)", 1, 2));
    qstVerify.push(new Parser(/^G\s(C\s\d{1,8}|I\s\d{1,6})$/, "G C coins(8 digits) or G I object(6 digits)", 0, 2));
    qstVerify.push(new Parser(/^R\s(A|C\s\d{1,8}|D\s[0-5]\s\d{1,6}|E\s\-?\d{1,8}|F|H\s\d{1,3}|I\s\d{1,6}|M\s\d{1,6}(\s\d{1,6})?|O\s\d{1,6}(\s\d{1,6})?|P\s\-?\d{1,6}|L|G|X|Q)$/, "G C coins(8 digits) or G I object(6 digits) or R A or R C coins(8 digit) or R D direction(1 digit) room(6 digit) or R E experience(+/- 8 digit) or R F or R H spell(3 digit) or R I object(6 digit) or R M mob(6 digit) optional: room(6 digit) or R O object(6 digit) optional: room(6 digit) or R P prestige(+/- 6 digit) or R L or R G or R X or R Q", 1, 0));
    qstVerify.push(new Parser(/^R\s(A|C\s\d{1,8}|D\s[0-5]\s\d{1,6}|E\s\-?\d{1,8}|F|H\s\d{1,3}|I\s\d{1,6}|M\s\d{1,6}(\s\d{1,6})?|O\s\d{1,6}(\s\d{1,6})?|P\s\-?\d{1,6}|L|G|X|Q)$/, "R A or R C coins(8 digit) or R D direction(1 digit) room(6 digit) or R E experience(+/- 8 digit) or R F or R H spell(3 digit) or R I object(6 digit) or R M mob(6 digit) optional: room(6 digit) or R O object(6 digit) optional: room(6 digit) or R P prestige(+/- 6 digit) or R L or R G or R X or R Q", 0, 1));
    qstVerify.push(new Parser(/^D$/, "D", 1, -11));
    qstVerify.push(new Parser(/^[^~]*$/, "disappear-message", 0, 1));
    qstVerify.push(new Parser(/^~$/, "~", -13, 0));
    qstVerify.push(new Parser(/^A\s\d{1,6}$/, "A room(6 digit)", 1, 7));
    qstVerify.push(new Parser(/^[^~]*$/, "completion-message", 0, 1));
    qstVerify.push(new Parser(/^~$/, "~", 1, 0));
    qstVerify.push(new Parser(/^R\s(A|C\s\d{1,8}|D\s[0-5]\s\d{1,6}|E\s\-?\d{1,8}|F|H\s\d{1,3}|I\s\d{1,6}|M\s\d{1,6}(\s\d{1,6})?|O\s\d{1,6}(\s\d{1,6})?|P\s\-?\d{1,6}|L|G|X|Q)$/, "R A or R C coins(8 digit) or R D direction(1 digit) room(6 digit) or R E experience(+/- 8 digit) or R F or R H spell(3 digit) or R I object(6 digit) or R M mob(6 digit) optional: room(6 digit) or R O object(6 digit) optional: room(6 digit) or R P prestige(+/- 6 digit) or R L or R G or R X or R Q", 0, 1));
    qstVerify.push(new Parser(/^D$/, "D", 1, -18));
    qstVerify.push(new Parser(/^[^~]*$/, "disappear-message", 0, 1));
    qstVerify.push(new Parser(/^~$/, "~", -20, 0));
    qstVerify.push(new Parser(/^S$/, "S", 1, 0));
    shpVerify.push(new Parser(/^SHOP:\s+\d{1,6}$/, "SHOP: mob-number(6 digit)", 1, 0));
    shpVerify.push(new Parser(/^ROOM:\s+\d{1,6}$/, "ROOM: room-number(6 digit)", 1, 1));
    shpVerify.push(new Parser(/^ROAMING:\s*$/, "ROAMING:", -1, 1));
    shpVerify.push(new Parser(/^CASTING:\s*$/, "CASTING:", -2, 1));
    shpVerify.push(new Parser(/^KILLABLE:\s*$/, "KILLABLE:", -3, 1));
    shpVerify.push(new Parser(/^GREED:\s+\d{2,4}$/, "GREED: greed(2-4 digits)", -4, 1));
    shpVerify.push(new Parser(/^PROFIT:\s+\d{1,4}$/, "PROFIT: profit(4 digits)", -5, 1));
    shpVerify.push(new Parser(/^DEADBEAT:\s+\d$/, "DEADBEAT: temper(1 digit)", -6, 1));
    shpVerify.push(new Parser(/^OFFENSE:\s+\d$/, "OFFENSE: temper(1 digit)", -7, 1));
    shpVerify.push(new Parser(/^(CHEATS|HATES):\s+(ALIEN|ALL|CA|CB|CC|CD|CE|CF|CH|CI|CK|CL|CM|CN|CP|CQ|CR|CS|CT|CU|CV|CZ|EVILS|GOODS|NPC|OWN|P2|PB|PD|PE|PF|PG|PH|PI|PL|PM|PO|PR|PT|PY|PZ)/, "HATES or CHEATS: ALIEN or ALL or CA or CB or CC or CD or CE or CF or CH or CI or CK or CL or CM or CN or CP or CQ or CR or CS or CT or CU or CV or CZ or EVILS or GOODS or NPC or OWN or P2 or PB or PD or PE or PF or PG or PH or PI or PL or PM or PO or PR or PT or PY or PZ", -8, 1));
    shpVerify.push(new Parser(/^HOURS:\s*(\s[CO]{24}|(\s\d{1,2}[\-,]\d{1,2})+)$/, "HOURS: C or O 24 times or multiple of hour(digits)-hour(2 digits)", -9, 1));
    shpVerify.push(new Parser(/^PO:\s+\d{1,6}/, "PO: object-number-list(6 digit)", -10, 1));
    shpVerify.push(new Parser(/^BT:(\s+\d{1,2})*$/, "BT: object-type(2 digit)", -11, 1));
    shpVerify.push(new Parser(/^MBCASH:\s+.*$/, "MBCASH: message", -12, 1));
    shpVerify.push(new Parser(/^MBHAVE:\s+.*$/, "MBHAVE: message", -13, 1));
    shpVerify.push(new Parser(/^MBIGOT:\s+.*$/, "MBIGOT: message", -14, 1));
    shpVerify.push(new Parser(/^MBUY:\s+.*$/, "MBUY: message", -15, 1));
    shpVerify.push(new Parser(/^MCLOSE:\s+.*$/, "MCLOSE: message", -16, 1));
    shpVerify.push(new Parser(/^MNBUY:\s+.*$/, "MNBUY: message", -17, 1));
    shpVerify.push(new Parser(/^MOPEN:\s+.*$/, "MOPEN: message", -18, 1));
    shpVerify.push(new Parser(/^MSCASH:\s+.*$/, "MSCASH: message", -19, 1));
    shpVerify.push(new Parser(/^MSELL:\s+.*$/, "MSELL: message", -20, 1));
    shpVerify.push(new Parser(/^MSHAVE:\s+.*$/, "MSHAVE: message", -21, 1));
    shpVerify.push(new Parser(/^$/, "a blank line", -22, 1));
    socVerify.push(new Parser(/^$/, "a blank line", 0, 1));
    socVerify.push(new Parser(/^MOB:\s\d{1,6}\sTRIGGER$/, "MOB: mob-number(6 digit) TRIGGER", 1, 16));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^TRIGGER:\s\d{1,3}$/, "TRIGGER: command(3 digit)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -9, 1));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -16, -6));
    socVerify.push(new Parser(/^MOB:\s\d{1,6}\sTIMED$/, "MOB: mob-number(6 digit) TIMED", 1, 16));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^HOUR:\s(\d|1\d|2[0-3])$/, "TRIGGER: hour(0-23)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -25, 1));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -32, -6));
    socVerify.push(new Parser(/^MOB:\s\d{1,6}\sPERIODIC$/, "MOB: mob-number(6 digit) PERIODIC", 1, 8));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -40, -6));
    socVerify.push(new Parser(/^MOB:\s\d{1,6}\sLIST$/, "MOB: mob-number(6 digit) LIST", 1, 10));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", 1, 0));
    socVerify.push(new Parser(/^CHANCE:\s\d{1,4}$/, "CHANCE: chance(4 digit)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,3}$/, "DELAY: delay(3 digit)", 1, 0));
    socVerify.push(new Parser(/^ACTION:\s(\d{1,4}|100\d)$/, "ACTION: command(0-1009)", 1, 0));
    socVerify.push(new Parser(/^[^~]+$/, "parameters", 0, 1));
    socVerify.push(new Parser(/^~$/, "~", 1, 0));
    socVerify.push(new Parser(/^FLAG:\s\d{1,3}$/, "FLAG: flags(3 digit)", -5, 1));
    socVerify.push(new Parser(/^DONE$/, "DONE", -7, 1));
    socVerify.push(new Parser(/^LISTDONE$/, "LISTDONE", -50, 0));
    socVerify.push(new Parser(/^MOB:\s\d{1,6}\sPATH$/, "MOB: mob-number(6 digit) PATH", 1, 7));
    socVerify.push(new Parser(/^ID:\s\d{1,4}$/, "ID: id-number(4 digit)", 1, 0));
    socVerify.push(new Parser(/^TYPE:\s[1-4]$/, "TYPE: type(1-4)", 1, 0));
    socVerify.push(new Parser(/^DELAY:\s\d{1,4}$/, "DELAY: delay(4 digit)", 1, 0));
    socVerify.push(new Parser(/^ROOMS:(\s\d{1,6}){1,50}$/, "ROOMS: room-list(4 digit, 50 max)", 1, 0));
    socVerify.push(new Parser(/^DIRS:(\s[0-5]){1,49}$/, "DIR: direction-list(0-5, 49 max)", 1, 0));
    socVerify.push(new Parser(/^DONE$/, "DONE", -57, 1));
    socVerify.push(new Parser(/^$/, "a blank line", 1, 0));
    wldVerify.push(new Parser(/^#\d{1,6}$/, "#room-number(6 digit)", 1, 0));
    wldVerify.push(new Parser(/^[^~]+~$/, "room-name~", 1, 0));
    wldVerify.push(new Parser(/^[^~]*$/, "room-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,4}\s\d{1,10}\s(\d|[12]\d|3[0-4])(\s\d{1,3}\s\d{1,3}\s\d{1,3}\s?)?$/, "zone-number(4 digit) room-flags(10 digit) sector-type(0-34) optional: length(3 digit) width(3 digit) height(3 digit)", 1, 0));
    wldVerify.push(new Parser(/^D0$/, "D0", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,2}\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^D1$/, "D1", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,2}\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^D2$/, "D2", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,2}\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^D3$/, "D3", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,2}\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^D4$/, "D4", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^\d{1,2}\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^D5$/, "D5", 1, 5));
    wldVerify.push(new Parser(/^[^~]+$/, "exit-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", 1, 0));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]*~$/i, "keywords-list(optional)~", 1, 0));
    wldVerify.push(new Parser(/^(\d|[12]\d|3[01])\s(\-2|\-1|\d{1,6})\s\d{1,6}(\s|\s[01]\s([0-6]|10|11)\s\d{1,4}\s\d{1,4}\s[01]\s\-?(\d{1,2}|100)\s(\d{1,2}|100))?$/, "door-flags(0-31) key-number(-1, -2, or 6 digit) room-number(6 digit) optional: trap-state(0 or 1) trap-type(0-6, 10, 11) minimum-damage(4 digit) maximum-damage(4 digit) area-effect(0 or 1) disarm-difficulty(-100 to 100) activation-chance(0-100)", 1, 0));
    wldVerify.push(new Parser(/^E$/, "E", 1, 4));
    wldVerify.push(new Parser(/^[0-9A-Z'\-\s]+~$/i, "keywords-list~", 1, 0));
    wldVerify.push(new Parser(/^[^~]*$/, "extra-description", 0, 1));
    wldVerify.push(new Parser(/^~$/, "~", -3, 0));
    wldVerify.push(new Parser(/^S$/, "S", 1, 0));
    zonVerify.push(new Parser(/^#\d{1,4}$/, "#zone-number(4 digit)", 1, 0));
    zonVerify.push(new Parser(/^\>\sfilename:\s\w+\.zon~$/, "> filename: the-filename.zon~", 1, 0));
    zonVerify.push(new Parser(/^[^~]+~$/, "zone-name~", 1, 0));
    zonVerify.push(new Parser(/^\d{1,6}\s\d{1,3}\s[0-2]\s\d{1,4}$/, "last-vnum(6 digit) pop-time(3 digit) reset-mode(0-2) zone=flags(4 digit)", 1, 0));
    zonVerify.push(new Parser(/^[1-8]\s\d{1,2}\s\d$/, "seasons-type(1-8) weather-flag(2 digit) mana-add(1 digit)", 1, 0));
    zonVerify.push(new Parser(/^[1-7]\s[0-7]\s[0-7]\s[0-7]$/, "season1-wind(1-7) season2-wind(0 or 1-7) season3-wind(0 or 1-7) season4-wind(0 or 1-7)", 1, 0));
    zonVerify.push(new Parser(/^[01]\s[01]\s[01]\s[01]$/, "season1-wind-varies(0 or 1) season2-wind-varies(0 or 1) season3-wind-varies(0 or 1) season4-wind-varies(0 or 1)", 1, 0));
    zonVerify.push(new Parser(/^[0-3]\s[0-3]\s[0-3]\s[0-3]$/, "season1-wind-direction(0-3) season2-wind-direction(0-3) season3-wind-direction(0-3) season4-wind-direction(0-3)", 1, 0));
    zonVerify.push(new Parser(/^[1-9]\s\d\s\d\s\d$/, "season1-precipitation(1-9) season2-precipitation(0 or 1-9) season3-precipitation(0 or 1-9) season4-precipitation(0 or 1-9)", 1, 0));
    zonVerify.push(new Parser(/^([1-9]|10|11)\s(\d|10|11)\s(\d|10|11)\s(\d|10|11)$/, "season1-temperature(1-11) season2-temperature(0 or 1-11) season3-temperature(0 or 1-11) season4-temperature(0 or 1-11)", 1, 0));
    zonVerify.push(new Parser(/^\d{1,3}$/, "exp-modifier(3 digit)", 1, 1));
    zonVerify.push(new Parser(/^\*/, "*", 1, 0));
    zonVerify.push(new Parser(/^(\*|$)/, "blank line or a comment", 0, 1));
    zonVerify.push(new Parser(/^B\s[01]\s\d{1,4}$/, "B if-flag(0 or 1) repeat-no(1-9999)", 1, 18));
    zonVerify.push(new Parser(/^(\*|$)/, "blank line or a comment", 0, 1));
    zonVerify.push(new Parser(/^C\s[01]\s\d{1,4}$/, "C if-flag(0 or 1) choices(1-9999)", -1, 1));
    zonVerify.push(new Parser(/^D\s[01]\s\d{1,6}\s[0-5]\s(\d|[12]\d|3[01])$/, "D if-flag(0 or 1) room-no(6 digit) exit-no(0-5) state(0-31)", -2, 1));
    zonVerify.push(new Parser(/^F\s[0-3]\s\d{1,6}\s\d{1,6}\s\d{1,6}$/, "F follow-type(0-3) room-no(6 digit) leader-no(6 digit) follower-no(6 digit)", -3, 1));
    zonVerify.push(new Parser(/^J\s[01]\s(0\s)?\d{1,4}$/, "J if-flag(0 or 1) jump-lines(4 digit) optional(if jump-lines = 0): jump-label(4 digit)", -4, 1));
    zonVerify.push(new Parser(/^L\s0\s\d{1,4}$/, "L 0 label-no(0-9999)", -5, 1));
    zonVerify.push(new Parser(/^M\s[01]\s\d{1,6}\s\-?\d{1,4}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "M if-flag(0 or 1) mob-no(6 digit) max-load(+/- 4 digit) room-no(6 digit) optional: rare-percent(0-100)", 1, 5));
    zonVerify.push(new Parser(/^C\s[01]\s\d{1,4}$/, "C if-flag(0 or 1) choices(1-9999)", 1, 1));
    zonVerify.push(new Parser(/^E\s[01]\s\d{1,6}\s\d{1,4}\s(\d|1\d|2[0-6])(\s\d{1,2}|\s100)?$/, "E if-flag(0 or 1) object-no(6 digit) max-load(4 digit) eq-position(0-26) optional: rare-percent(0-100)", -1, 1));
    zonVerify.push(new Parser(/^P\s[01]\s\d{1,6}\s\d{1,4}\s\d{1,6}(\s\-\d{1,4}|\s\d{1,2}|\s100)?$/, "P if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) container-no(6 digit) optional: rare-percent or quantity(0-100 or -4 digit)", 0, 1));
    zonVerify.push(new Parser(/^G\s[01]\s\d{1,6}\s\d{1,4}(\s\d{1,2}|\s100)?$/, "G if-flag(0 or 1) object-no(6 digit) max-load(4 digit) optional: rare-percent(0-100)", -3, -10));
    zonVerify.push(new Parser(/^O\s[01]\s\d{1,6}\s\-?\d{1,4}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "O if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) room-no(6 digit) optional: rare-percent(0-100)", 1, 2));
    zonVerify.push(new Parser(/^P\s[01]\s\d{1,6}\s\d{1,4}\s\d{1,6}(\s\-\d{1,4}|\s\d{1,2}|\s100)?$/, "P if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) container-no(6 digit) optional: rare-percent or quantity(0-100 or -4 digit)", 0, -12));
    zonVerify.push(new Parser(/^R\s[01]\s\d{1,6}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "R if-flag(0 or 1) room-no(6 digit) object-no(6 digit) optional: rare-percent(0-100)", -13, 1));
    zonVerify.push(new Parser(/^T\s[01]\s(\-1|\d|1\d|2[0-3])\s(\d|1\d|2\d|3[0-5])\s[0-7]\s(\d|1[0-7])$/, "T if-flag(0 or 1) hour(-1-23) month-day(0-35) weekday(0-7) month(0-17)", -14, 1));
    zonVerify.push(new Parser(/^X\s[01]\s(\-1|\d{1,6})\s\d{1,6}(\s[01](\s\d{1,2}|\s100)?)?$/, "X if-flag(0 or 1) room-no(-1 or 6 digit) mob-no(6 digit) optional: combat-toggle(0 or 1) and optional: rare-percent(0-100)", -15, 1));
    zonVerify.push(new Parser(/^B\s0\s0$/, "B 0 0", -18, 0));
    zonVerify.push(new Parser(/^C\s[01]\s\d{1,4}$/, "C if-flag(0 or 1) choices(1-9999)", -18, 1));
    zonVerify.push(new Parser(/^D\s[01]\s\d{1,6}\s[0-5]\s(\d|[12]\d|3[01])$/, "D if-flag(0 or 1) room-no(6 digit) exit-no(0-5) state(0-31)", -19, 1));
    zonVerify.push(new Parser(/^F\s[0-3]\s\d{1,6}\s\d{1,6}\s\d{1,6}$/, "F follow-type(0-3) room-no(6 digit) leader-no(6 digit) follower-no(6 digit)", -20, 1));
    zonVerify.push(new Parser(/^J\s[01]\s(0\s)?\d{1,4}$/, "J if-flag(0 or 1) jump-lines(4 digit) optional(if jump-lines = 0): jump-label(4 digit)", -21, 1));
    zonVerify.push(new Parser(/^L\s0\s\d{1,4}$/, "L 0 label-no(0-9999)", -22, 1));
    zonVerify.push(new Parser(/^M\s[01]\s\d{1,6}\s\-?\d{1,4}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "M if-flag(0 or 1) mob-no(6 digit) max-load(+/- 4 digit) room-no(6 digit) optional: rare-percent(0-100)", 1, 5));
    zonVerify.push(new Parser(/^C\s[01]\s\d{1,4}$/, "C if-flag(0 or 1) choices(1-9999)", 1, 1));
    zonVerify.push(new Parser(/^E\s[01]\s\d{1,6}\s\d{1,4}\s(\d|1\d|2[0-6])(\s\d{1,2}|\s100)?$/, "E if-flag(0 or 1) object-no(6 digit) max-load(4 digit) eq-position(0-26) optional: rare-percent(0-100)", -1, 1));
    zonVerify.push(new Parser(/^P\s[01]\s\d{1,6}\s\d{1,4}\s\d{1,6}(\s\-\d{1,4}|\s\d{1,2}|\s100)?$/, "P if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) container-no(6 digit) optional: rare-percent or quantity(0-100 or -4 digit)", 0, 1));
    zonVerify.push(new Parser(/^G\s[01]\s\d{1,6}\s\d{1,4}(\s\d{1,2}|\s100)?$/, "G if-flag(0 or 1) object-no(6 digit) max-load(4 digit) optional: rare-percent(0-100)", -3, -27));
    zonVerify.push(new Parser(/^O\s[01]\s\d{1,6}\s\-?\d{1,4}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "O if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) room-no(6 digit) optional: rare-percent(0-100)", 1, 2));
    zonVerify.push(new Parser(/^P\s[01]\s\d{1,6}\s\d{1,4}\s\d{1,6}(\s\-\d{1,4}|\s\d{1,2}|\s100)?$/, "P if-flag(0 or 1) object-no(6 digit) max-load(+/- 4 digit) container-no(6 digit) optional: rare-percent or quantity(0-100 or -4 digit)", 0, -29));
    zonVerify.push(new Parser(/^R\s[01]\s\d{1,6}\s\d{1,6}(\s\d{1,2}|\s100)?$/, "R if-flag(0 or 1) room-no(6 digit) object-no(6 digit) optional: rare-percent(0-100)", -30, 1));
    zonVerify.push(new Parser(/^T\s[01]\s(\-1|\d|1\d|2[0-3])\s(\d|1\d|2\d|3[0-5])\s[0-7]\s(\d|1[0-7])$/, "T if-flag(0 or 1) hour(-1-23) month-day(0-35) weekday(0-7) month(0-17)", -31, 1));
    zonVerify.push(new Parser(/^X\s[01]\s(\-1|\d{1,6})\s\d{1,6}(\s[01](\s\d{1,2}|\s100)?)?$/, "X if-flag(0 or 1) room-no(-1 or 6 digit) mob-no(6 digit) optional: combat-toggle(0 or 1) and optional: rare-percent(0-100)", -32, 1));
    zonVerify.push(new Parser(/^(\*|$)/, "blank line or a comment", -33, 0));

    function showPalette() {
      var red, green, blue, button, color, lumin, menu, textColor;
      button = document.getElementById('color-1');
      button.addEventListener('click', changeColor);
      for(var index = 0; index < 16; index++) {
        color = colors[index];
        red = parseInt(color.substr(1,2), 16);
        green = parseInt(color.substr(3,2), 16);
        blue = parseInt(color.substr(5,2), 16);
        lumin = Math.max(red, green, blue);
        button = document.getElementById('color' + index);
        button.addEventListener('click', changeColor);
        button.addEventListener('contextmenu', changeColor);
        menu = document.getElementById('palette' + index);
        menu.addEventListener('change', changePalette);
        menu.addEventListener('click', clickPalette);
        menu.addEventListener('contextmenu', clickPalette);
        button.style.backgroundColor = color;
        menu.style.backgroundColor = color;
        textColor = lumin > 128 ? "#000000" : "#FFFFFF";
        button.style.color = textColor;
        menu.style.color = textColor;
        for(let option of menu.childNodes) {
          option.style.color = textColor;
          option.style.backgroundColor = colors[parseInt(option.innerText.substr(2,3))];
        }
        if (index < 16) {
          button.innerHTML = "&nbsp;&+" + "lrgybmcwLRGYBMCW".substr(index,1) + "&nbsp;";
        } else {
          button.innerText = "&f" + ("00" + index).slice(-3);
        }
        menu.firstChild.innerHTML = button.innerHTML;
      }
    }

    function changePalette(evt) {
      var button = document.getElementById(evt.target.id.replace("palette", "color"));
      button.innerText = evt.target.value;
      for(let option of evt.target.childNodes) {
        if (option.innerText == button.innerText) {
          evt.target.style.backgroundColor = option.style.backgroundColor;
          button.style.backgroundColor = option.style.backgroundColor;
          setTextColor(option.style.backgroundColor);
          break;
        }
      }
    }

    function clickPalette(evt) {
      if (evt.button === 2 || evt.which === 3) {
        changeColor(evt);
      }
    }

    function changeColor(evt) {
      var rightClick, color, colorButton;
      var paletteNo = parseInt(evt.target.id.replace(/[a-z]*(\-?\d+)/i, "$1"));
      if (paletteNo < 0) {
        setBackgroundColor("#000000");
        setTextColor(defaultColor);
        return;
      }
      rightClick = evt.button === 2 || evt.which === 3;
      colorButton = document.getElementById('color' + paletteNo);
      color = colorButton.style.backgroundColor;
      if (rightClick) {
        evt.preventDefault();
        if (paletteNo >= 8) {
          alert("Only colors &+l, &+r, &+g, &+y, &+b, &+m, &+c, &+w can be used as the background color.");
          return;
        }
        if (colorButton.innerText.substr(0,2) == "&f") {
          color = colors[paletteNo];
          alert("Only colors &+l, &+r, &+g, &+y, &+b, &+m, &+c, &+w can be used as the background color.  Setting background color to " + "&+l&+r&+g&+y&+b&+m&+c&+w".substr(paletteNo * 3, 3));
        }
        setBackgroundColor(color);
      } else {
        setTextColor(color);
      }
    }

    function setTextColor(color) {
      var colorButton, colorMenu;
      var colorStr = color;
      var rgba = stringToRGBA(colorStr);
      if (rgba != null) {
        rgba = RGBAtoRGB(rgba, [0,0,0]);
        colorStr = "#" + ("0" + parseInt(rgba[0]).toString(16)).slice(-2)
          + ("0" + parseInt(rgba[1]).toString(16)).slice(-2)
          + ("0" + parseInt(rgba[2]).toString(16)).slice(-2);
      }
      fileIn.focus();
      document.execCommand('styleWithCSS', false, true);
      document.execCommand("foreColor", false, colorStr);
      for(var index = 0; index < 16; index++) {
        colorButton = document.getElementById('color' + index);
        colorMenu = document.getElementById('palette' + index);
        if (colorButton.style.backgroundColor == color) {
          colorButton.style.display = "none";
          colorMenu.style.display = "inline";
        } else {
          colorButton.style.display = "inline";
          colorMenu.style.display = "none";
        }
      }
    }

    function setBackgroundColor(color) {
      fileIn.focus();
      document.execCommand("backColor", false, color);
    }

    function readSingleFile(evt) {
      var file = evt.target.files[0];
      if (!file) { return; }
      fileName = file.name;
      fileType = fileName.slice(-4).toLowerCase();
      if (".mob:.obj:.pow:.qst:.shp:.soc:.wld:.zon".indexOf(fileType) < 0) {
        alert("The selected file must be of .mob, .obj, .pow, .qst, .shp, .soc, .wld, or .zon file type.");
        return;
      }
      var reader = new FileReader();
      reader.onload = function(evt) { displayContents(evt.target.result); };
      reader.readAsText(file);
      saveFile.setAttribute("download", fileName);
      document.getElementById('fileTitle').innerText = fileName;
    }

    function displayContents(contents) {
      fileLines = contents.split(/\r?\n/);
      var ansiWhole = ("&n" + contents).replace(/\r?\n/g, "</div><div>&n")
        .replace(/&n/gi, "&-l&f256").replace(/&\-l&f256<\/div>/gi, "&n</div>")
        .replace(/<div>&n<\/div>/gi, "<div><br></div>")
        .replace(/&cl|&\+l/g, "&f000").replace(/&cr|&\+r/g, "&f001")
        .replace(/&cg|&\+g/g, "&f002").replace(/&cy|&\+y/g, "&f003")
        .replace(/&cb|&\+b/g, "&f004").replace(/&cm|&\+m/g, "&f005")
        .replace(/&cc|&\+c/g, "&f006").replace(/&cw|&\+w/g, "&f007")
        .replace(/&cL|&\+L/g, "&f008").replace(/&cR|&\+R/g, "&f009")
        .replace(/&cG|&\+G/g, "&f010").replace(/&cY|&\+Y/g, "&f011")
        .replace(/&cB|&\+B/g, "&f012").replace(/&cM|&\+M/g, "&f013")
        .replace(/&cC|&\+C/g, "&f014").replace(/&cW|&\+W/g, "&f015")
        .replace(/ /g, "&nbsp;");
      ansiWhole = ansiWhole.replace(/(&\-[bcglmrwy])+&\-/g, "&-");
      ansiWhole = ansiWhole.replace(/(&f\d\d\d)+&f/g, "&f");
      ansiWhole = ansiWhole.replace(/(&\-[bcglmrwy]|&f\d\d\d|)+(&f\d\d\d&\-[bcglmrwy])/g, "$2");
      ansiWhole = ansiWhole.replace(/(&\-[bcglmrwy]|&f\d\d\d|)+(&\-[bcglmrwy]&f\d\d\d)/g, "$2");
      ansiWhole = ansiWhole
        .replace(/&-l/gi, "&f257").replace(/&-r/gi, "&f258")
        .replace(/&-g/gi, "&f259").replace(/&-y/gi, "&f260")
        .replace(/&-b/gi, "&f261").replace(/&-m/gi, "&f262")
        .replace(/&-c/gi, "&f263").replace(/&-w/gi, "&f264")
      var ansiPieces = ansiWhole.split(/&f/);
      fileIn.innerHTML = '<div>' + ansiPieces.map(processAnsi).join("").replace(/"><\/span><span style="/g, ";"); + '</div>';
    }

    function processAnsi(str) {
       if (str.length < 3) { return; }
       var colNo = parseInt(str.slice(0,3));
       if (colNo < 257) { return '<span style="color:' + colors[colNo] + '">' + str.slice(3) + '</span>'; }
       return '<span style="background-color:' + colors[colNo - 257] + '">' + str.slice(3) + '</span>';
    };

    function validateFile() {
      var index, msg, next, start = 0, state = 0;
      var fileErrors, fileParser = null;
      fileToArray();
      verifyWindow = window.open("", "", "toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=400");
      verifyWindow.document.write("<div id='file-errors'></div>");
      verifyWindow.document.title = fileName + " Errors";
      fileErrors = verifyWindow.document.getElementById('file-errors');
      fileErrors.focus();
      fileErrors.innerHTML = "";
      msg = fileLines.pop();
      if (msg.length > 0 && fileType != ".zon") {
        printTo(fileErrors, "Expected a blank line at end of file.");
      }
      while (msg.length == 0) {
        msg = fileLines.pop();
      }
      fileLines.push(msg);
      if (fileType == ".mob") {
        fileParser = mobVerify;
        if (fileLines[0] != "<*> File Version 1 <*>") {
          printTo(fileErrors, "Expected '<*> File Version 1 <*>' at start of file.");
        } else { start = 1; }
      }
      if (fileType == ".obj") {
        fileParser = objVerify;
      }
      if (fileType == ".pow") {
        printTo(fileErrors, "For validation use jsonlint.com.");
      }
      if (fileType == ".qst") {
        fileParser = qstVerify;
      }
      if (fileType == ".shp") {
        fileLines = fileLines.map(function(line)
          { return line.replace(/\s*;;.*$/,"");});
        fileParser = shpVerify;
      }
      if (fileType == ".soc") {
        fileLines = fileLines.map(function(line)
          { return line.replace(/\s*;;.*$/,"");});
        fileParser = socVerify;
      }
      if (fileType == ".wld") {
        fileParser = wldVerify;
        if (fileLines[0] != "<*> File Version 1 <*>") {
          printTo(fileErrors, "Expected '<*> File Version 1 <*>' at start of file.");
        } else { start = 1; }
      }
      if (fileType == ".zon") {
        fileLines = fileLines.map(function(line)
          { return line.replace(/\s+\*.*$/,"");});
        fileParser = zonVerify;
        msg = fileLines.pop();
        if (msg != "S") {
          fileLines.push(msg);
          printTo(fileErrors, "Expected S at end of file.");
        }
      }
      if (fileParser === null) return;
      msg = "";
      for(index = start; index < fileLines.length; index++) {
          if (state < 0) {
            for(state = 0; state < fileParser.length; state++) {
              if (fileLines[index].search(fileParser[state].regex) >= 0) {
                break;
              }
            }
            if (state == fileParser.length) { state = 0; }
          }
        if (fileLines[index].search(fileParser[state].regex) < 0) {
          if (!msg.includes(fileParser[state].failMessage)) {
            if (msg.length > 0) { msg += "<br>&nbsp;&nbsp;"; }
            msg += fileParser[state].failMessage;
          }
          if (fileParser[state].onBad != 0) {
            state += fileParser[state].onBad;
            index--;
          } else {
            printTo(fileErrors, (index + 1) + " Expected: " + msg);
            state = -1;
            msg = "";
          }
        } else {
          state += fileParser[state].onGood;
          msg = "";
        }
        if (state >= fileParser.length) { state = 0; }
      }
      if (fileErrors.innerHTML.length == 0) {
        printTo(fileErrors, "No errors found.");
      }
    }

    function fileToArray() {
      fileIn.normalize();
      fileLines.length = 0;
      if (fileIn.childNodes.length == 0) { return; }
      var line, node = fileIn.firstChild;
      line = ""; lastAnsiF = "&f256"; lastAnsiB = "&-l";
      while (node != null) {
        line += nodeText(node, fileIn);
        if (node.nodeName == "DIV" || node.nextSibling == null || node.nextSibling.nodeName == "DIV") {
          fileLines.push(line);
          line = ""; lastAnsiF = "&f256"; lastAnsiB = "&-l";
        }
        node = node.nextSibling;
      }
    }

    function nodeText(node, element) {
      if (node.nodeType == 3) {
        var foreRGBA = stringToRGBA(window.getComputedStyle(element, null).getPropertyValue("color"));
        var backRGBA = stringToRGBA(window.getComputedStyle(element, null).getPropertyValue("background"));
        if (foreRGBA == null) { foreRGBA = [parseInt(defaultColor.substr(1,2), 16),parseInt(defaultColor.substr(3,2), 16),parseInt(defaultColor.substr(5,2), 16),1]; }
	if (backRGBA == null) { backRGBA = [0, 0, 0, 1]; }
        var foreAnsi = colorToAnsi(RGBAtoRGB(foreRGBA, backRGBA), 257);
        var backAnsi = colorToAnsi(RGBAtoRGB(backRGBA, [0, 0, 0]), 8).replace("&c", "&-");
	if (backAnsi == lastAnsiB || node.nodeValue.length == 0) { backAnsi = ""; }
        else { lastAnsiB = backAnsi; }
	if (foreAnsi == lastAnsiF || node.nodeValue.length == 0) { foreAnsi = ""; }
        else { lastAnsiF = foreAnsi; }
        if (foreAnsi == "&f256") {
          if (backRGBA[0] == 0 || backRGBA[1] == 0 || backRGBA[2] == 0)
            { return "&n" + node.nodeValue; }
          foreAnsi = colorToAnsi(foreRGBA, 256);
        }
        return backAnsi + foreAnsi + node.nodeValue.replace(/\xA0/g, " ");
      }
      if (node.nodeType != 1) { return ""; }
      var text = "";
      for(var index = 0; index < node.childNodes.length; index++) {
        text += nodeText(node.childNodes[index], node);
      }
      return text;
    }

    function RGBAtoRGB(rgba, back) {
      var rgb = rgba, alpha = rgba[3];
      rgb.pop();
      if (alpha < 1) {
        rgb[0] = (1 - alpha) * back[0] + alpha * rgb[0];
        rgb[1] = (1 - alpha) * back[1] + alpha * rbg[1];
        rgb[2] = (1 - alpha) * back[2] + alpha * rgb[2];
      }
      return rgb;
    }

    function stringToRGBA(str) {
      var colorParts = /rgba?\((\d+),\s?(\d+),\s?(\d+),?\s?(\d?\.?\d*)?\).*/.exec(str);
      if (colorParts != null) {
        colorParts.shift();
        if (colorParts.length = 3) { colorParts.push(1); }
      }
      return colorParts;
    }

    function writeFile(e) {
      fileToArray();
      var fileBlob = new Blob([fileLines.join("\n")], {type : 'text/plain'});
      window.URL.revokeObjectURL(saveFile.href);
      saveFile.href = window.URL.createObjectURL(fileBlob);
      saveFile.download = fileName;
//      var uri = "";
//      for(var index = 0; index < fileLines.length; index++) {
//        uri += encodeURIComponent(fileLines[index] + "\n");
//      }
//      saveFile.download = fileName;
//      saveFile.setAttribute('href', 'data:text/plain;charset=utf-8,' + uri);
    }

    function Parser(pattern, message, success, failure) {
      this.regex = pattern;
      this.failMessage = message;
      this.onGood = success;
      this.onBad = failure;
    }

    function printTo(control, text) {
      control.innerHTML += "<div>" + text + "</div>";
    }

    function colorToAnsi(rgbIn, maxColor) {
      var bestMatch = 0, bestDistance = 585225, index;
      var rgbDistance, deltaR, deltaG, deltaB;
      for(index = 0; index < maxColor; index++) {
         deltaR = rgbIn[0] - parseInt(colors[index].substr(1,2), 16);
         deltaG = rgbIn[1] - parseInt(colors[index].substr(3,2), 16);
         deltaB = rgbIn[2] - parseInt(colors[index].substr(5,2), 16);
         rgbDistance = 2 * deltaR * deltaR + 4 * deltaG * deltaG + 3 * deltaB * deltaB;
         if (rgbDistance < bestDistance) {
           bestDistance = rgbDistance;
           bestMatch = index;
         }
      }
      if (bestMatch < 16) {
        return "&c" + "lrgybmcwLRGYBMCW".substr(bestMatch,1);
      } else {
        if (bestMatch < 100) { bestMatch = "0" + bestMatch; }
        return "&f" + bestMatch;
      }
    }

    function showLineNo() {
      if (document.activeElement != fileIn) { return; }
      var line = 1, cursorNode = window.getSelection().anchorNode;
      if (cursorNode != fileIn) {
        while (cursorNode.parentNode != fileIn) {
          cursorNode = cursorNode.parentNode;
        }
        while(cursorNode != fileIn.firstChild) {
          cursorNode = cursorNode.previousSibling;
          if (cursorNode.nodeName == "DIV") { line++; }
          else {
            line++;
            while (cursorNode != fileIn.firstChild && cursorNode.previousSibling.nodeName != "DIV") {
              cursorNode = cursorNode.previousSibling;
            }
          }
        }
      }
      line = String(line);
      if (line.length < 5) { line += "&nbsp;".repeat(5 - line.length); }
      document.getElementById('lineNo').innerHTML = line;
    }

    showPalette();
    document.getElementById('file-input').addEventListener('change', readSingleFile);
    </script>
  </body>
</html>
